# 📚 캐시(Cache)

![cache image](https://dbscthumb-phinf.pstatic.net/4751_000_3/20170718130012494_BLPQUWIQ7.jpg/992_170560_15432.jpg?type=w492_fst&wm=N)

## ❔ 캐시 메모리란?

- 캐시(Cache) : 자주 필요한 데이터를 복사하여 임시적으로 보관하는 저장소

CPU와 주억장치(main memory)간의 데이터 속도 향상(빠른 데이터 전달)을 위해 중간 버퍼 역할을 하여 시스템 성능을 향상시키는 임시저장소

<br/>

## ❔ 캐시가 나타나게 된 배경

데이터 처리를 위해 끊임없이 데이터를 주고받는구조의 CPU가 빠르게 데이터를 전달 -> 메모리가 CPU의 빠른 데이터 처리 속도를 쫓아가지 못함 -> CPU가 메모리를 기다려야하는 병목현상 발생

CPU의 병목현상을 완화시키기 위한 방법으로 작은 저장공간의 속도가 빠른 캐시메모리를 위치시켜 향후 재사용 가능성이 높은 데이터들을 저장해두어 CPU가 요청하는 데이터를 빠르게 처리한다.

<br/>

---

## 👍 캐시의 장점

![](https://velog.velcdn.com/images/rachelyu1025/post/1e0e7748-e519-489f-aa30-8448ef0fa9c6/image.png)

- 계산, 접근 시간 없이 데이터를 빠르게 액세스 가능하다.
  - 만약 캐시가 없다면 매번 필요한 데이터를 요청 및 응답으로 받아야하므로 비효율적이다.

<br/>

## 👎 캐시의 단점

- 저장공간이 작으며, 영구적이지 않다.
- 비용이 많이 든다.

<br/>

---

<br/>

## 🤔 캐시는 어떻게 사용될까?

<br/>

### ❔ 재사용 가능한 데이터를 어떻게 구분하죠?

'데이터지역성' 원리를 이용한다.

- '데이터 지역성' : 자주 사용되는 데이터는 시간적 혹은 공간적으로 가깝게 일어난다는 원리
  - 한 번 참조된 데이터는 잠시 후에 또 다시 참조될 가능성이 높다.
  - 어떤 데이터에 접근할 때, 근처의 다른 데이터 또한 참조될 가능성이 높다.

<br/>

- '데이터 지역성'의 종류

1. 시간 지역성(Temporal Locality)
   : 특정 데이터가 한 번 접근되었을 경우, 가까운 미래에 또 한번 데이터에 접근할 가능성이 높은 것

- 메모리 상의 같은 주소에 여러차례 읽기/쓰기를 수행하는 경우 상대적으로 작은 크기의 캐시를 사용해 효율성을 높일 수 있다.

ex) for문과 같은 반복문 내 선언한 (i와 같은)변수는 반복이 끝나기 전까지 계속 사용될 확률이 높음

<br/>

2. 공간 지역성(Spatial Locality)
   : 특정 데이터와 가까운 주소가 순서대로 접근되는 경우

ex) 배열에서 index로 요소 접근 시, 접근한 요소 인덱스의 다음 인덱스에 접근할 확률이 높음

- 데이터가 순차적으로 액세스되는 경우를 순차지역성(Sequential Locality)이라고 함

<br/>

### ❔ 캐시 작동 방식

- 원본 데이터와는 별개로 자주 쓰이는 데이터들을 복사해둘 캐시공간을 마련한다.
  - 상수시간(O(1)) 등 낮은 시간복잡도로 접근 가능한 곳을 주로 사용한다.
- 데이터 요청이 들어오면 캐시 내부에 찾고자 하는 데이터가 존재하는지 먼저 찾는다.
- 캐시메모리 내 찾고자하는 데이터가 '있다면' 원본 데이터에 접근하지 않고 바로 해당 데이터를 제공한다.
  - 이를 캐시 적중했다하여 'Cache hit' 이라고 한다.
- 캐시 메모리 내 찾고자하는 데이터가 '없거나(Cache Miss)' 너무 오래되어 '최신성을 잃었다면(Expiration)' 원본 데이터에 접근하여 데이터를 가져온다.

  - 이 때, 데이터를 가져오면서 캐시에 해당 데이터를 복사하거나 갱신한다.(캐싱)

### 💡 언제 사용하면 좋을까?

- 데이터에 직접적으로 접근하는데 걸리는 시간이 오래 걸릴 때
- 필요한 값을 얻기 위해 계산하는 과정을 생략하고 싶을 때
- 반복적으로 동일한 결과를 돌려주는 경우

---

<br/>

## 🤔 캐시는 어디서 사용될까?

- CPU의 캐시메모리
- 하드디스크, DB
- CDN
- 웹캐시

<br/>

### 📚 웹캐시

- 브라우저 캐시 : 웹브라우저는 웹페이지 접속 시 HTML,CSS,JS, 이미지 등을 하드디스크나 메모리에 캐싱해두었다가 다음 번에 접속 시 재사용한다.

- 응답 캐시 : '동적' 웹페이지라도 매번 내용이 바뀌지 않는 경우가 대부분이므로, 서버에서 생성한 HTML을 (웹서버에서) 캐싱해두었다가 다음 번 요청 시 재사용한다.

- 프록시 캐시: 클라이언트에서 자주 요청받는 내용은 웹서버 앞단의 프록시 서버에서 캐싱해둔 데이터를 바로 제공하기도 한다.

## 💡 HTTP Cache

: 불필요한 네트워크 요청 방지

![cache processing](https://thisblogfor.me/static/26964d32468e2e565e43d36b722855b8/ad34c/cache-processing-flow-chart.png)

1. 요청 : 서버에 요청을 보내기 전, 브라우저 캐시에 요청하고자 하는 데이터가 존재하는지 여부를 확인한다.

❔ 데이터가 브라우저 캐시 내 존재한다면? (cache hit) 데이터 사용

- 만약 캐시에 요청하고자 하는 데이터가 존재하지만, 서버의 데이터가 업데이트 되었다면?(캐시 내 존재하는 데이터와 서버의 데이터가 다른경우) <br/> 
- Etag(유효성 검사 토큰)를 이용하여 서버가 가진 데이터와 캐시 내 존재하는 데이터가 같은 데이터인지 구분한다.(요청 시 If-None-Match 헤더에 Etag값을 보내는 형식)
- 데이터를 응답으로 보내줄 시 캐싱 가능한 최대시간을 cache-control http header 에 max-age값으로 명시해준다.

![cache-controlHeader](https://devcenter2.assets.heroku.com/article-images/782-imported-1443570289-782-imported-1443554757-51-original.jpg)

- 캐시 내 데이터 이용기간이 만료되었다면?

  ❔ 만료시간이 되었지만 캐시 업데이트가 필요하지 않은 경우(캐시 내 데이터와 서버의 데이터가 같은경우) <br/>

  - 만료될 때마다 같은 데이터를 매번 받아오는 것 또한 불필요한 네트워크 비용이 발생한다.

  <br/>

  ![if-none-match](https://velog.velcdn.com/images%2Fcode_newb%2Fpost%2Fe06860b8-2ed8-4b2a-9629-07c01c7dd2a5%2Fimage.png)

  - Etag(유효성 검사 토큰)를 이용하여 서버가 가진 데이터와 캐시 내 존재하는 데이터가 같은 데이터인지 구분한다. <br/>
    같은 데이터라면(Etag를 보냄) 캐싱 기간을 갱신해주는 방안을 택하고, 다르다면 새 Etag, max-age와 함께 서버의 업데이트 된 데이터를 보내준다.

🤔 브라우저의 캐싱된 데이터는 '만료'될 때까지 사용된다.

❔ 만료가 되지 않았지만 서버의 데이터 업데이트가 이루어진 경우

- 정적파일의 경우 업데이트가 자주 이루어지지 않으므로 만료시간을 길게 두는데, 이로 인해 사용자는 데이터가 만료될 때까지 업데이트 된 데이터를 받아보지 못한다.

  ![](https://velog.velcdn.com/images/rachelyu1025/post/3a4f1dba-8085-457c-98c6-a6cd58650cdf/image.png)

  - 리소스 URL을 변경하는 방식으로 해결한다.<br/>
    : 파일명 사이에 버전번호를 작성함으로써 url이 바뀌도록 하여 브라우저가 새 데이터라고 인지하도록 하여 업데이트를 하는 방식

<br/>

Reference

- [cache](https://terms.naver.com/entry.naver?docId=3609933&cid=58598&categoryId=59316)
- [cache2](https://youtu.be/JBFT4KyEvoY)
- [http cache](https://youtu.be/NxFJ-mJdVNQ)
- [http cache 2](https://youtu.be/NxFJ-mJdVNQ)
- [cache processing](https://thisblogfor.me/web/http/cache/)
